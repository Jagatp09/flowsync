<%- include('../partials/managerSidebar', { activePage: 'checklists' }) %>

<main class="flex-1 ml-64">
  <!-- Top Bar -->
  <header class="h-16 border-b border-primary/10 bg-white dark:bg-slate-900 px-8 flex items-center justify-between sticky top-0 z-10">
    <div class="flex items-center gap-4">
      <a href="/manager/checklists" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
        <span class="material-symbols-outlined text-slate-500">arrow_back</span>
      </a>
      <h2 class="text-xl font-bold text-slate-900 dark:text-white"><%= checklist.title %></h2>
      <% if (checklist.shiftType === 'MORNING') { %>
        <span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded">Morning</span>
      <% } else if (checklist.shiftType === 'MIDDAY') { %>
        <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">Midday</span>
      <% } else if (checklist.shiftType === 'EVENING') { %>
        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-bold rounded">Evening</span>
      <% } %>
    </div>
    <div class="flex items-center gap-3">
      <% if (checklist.isActive) { %>
        <span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">Active</span>
      <% } else { %>
        <span class="px-3 py-1 bg-slate-100 text-slate-700 text-xs font-bold rounded-full">Inactive</span>
      <% } %>
    </div>
  </header>

  <div class="p-8 space-y-8">
    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg flex items-center gap-3">
        <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400">check_circle</span>
        <p class="text-sm text-emerald-700 dark:text-emerald-300"><%= success %></p>
      </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center gap-3">
        <span class="material-symbols-outlined text-red-600 dark:text-red-400">error</span>
        <p class="text-sm text-red-700 dark:text-red-300"><%= error %></p>
      </div>
    <% } %>

    <!-- Description -->
    <% if (checklist.description) { %>
      <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <p class="text-slate-600 dark:text-slate-400"><%= checklist.description %></p>
      </div>
    <% } %>

    <!-- Add Task Form -->
    <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6">
      <h3 class="font-bold text-lg mb-4">Add New Task</h3>
      <form action="/manager/checklists/<%= checklist.id %>/items" method="POST" class="flex gap-4">
        <input type="text" name="text" required placeholder="Enter task description" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white"/>
        <select name="category" class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
          <option value="General">General</option>
          <option value="Operations">Operations</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Inventory">Inventory</option>
          <option value="Management">Management</option>
          <option value="Security">Security</option>
        </select>
        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 font-bold">Add Task</button>
      </form>
    </div>

    <!-- Tasks List -->
    <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
      <div class="p-6 border-b border-slate-200 dark:border-slate-800">
        <h3 class="font-bold text-lg">Tasks (<%= checklist.items ? checklist.items.length : 0 %>)</h3>
      </div>
      <div class="divide-y divide-slate-100 dark:divide-slate-800">
        <% if (checklist.items && checklist.items.length > 0) { %>
          <% checklist.items.sort((a, b) => a.sortOrder - b.sortOrder).forEach(function(item, index) { %>
            <div class="p-4 px-6 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50">
              <div class="flex items-center gap-4">
                <span class="text-sm text-slate-400 w-6"><%= index + 1 %></span>
                <div>
                  <p class="font-medium text-slate-900 dark:text-white"><%= item.text %></p>
                  <span class="text-xs text-slate-500"><%= item.category %></span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="openEditItemModal('<%= item.id %>', '<%= item.text.replace(/'/g, "\\'") %>', '<%= item.category %>')" class="p-2 text-primary hover:bg-primary/5 rounded-lg">
                  <span class="material-symbols-outlined text-[20px]">edit</span>
                </button>
                <button onclick="confirmDeleteItem('<%= item.id %>', '<%= item.text.replace(/'/g, "\\'") %>')" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg">
                  <span class="material-symbols-outlined text-[20px]">delete</span>
                </button>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="p-8 text-center text-slate-500">
            No tasks yet. Add your first task above.
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<!-- Edit Item Modal -->
<dialog id="editItemModal" class="modal p-6 rounded-xl border border-slate-200 dark:border-slate-700 backdrop:bg-slate-900/50 w-full max-w-md">
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-slate-900 dark:text-white">Edit Task</h3>
      <button onclick="document.getElementById('editItemModal').close()" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded">
        <span class="material-symbols-outlined text-slate-500">close</span>
      </button>
    </div>
    <form id="editItemForm" method="POST">
      <input type="hidden" name="_method" value="PUT"/>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Task Description</label>
          <input type="text" name="text" id="editItemText" required class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Category</label>
          <select name="category" id="editItemCategory" class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
            <option value="General">General</option>
            <option value="Operations">Operations</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Inventory">Inventory</option>
            <option value="Management">Management</option>
            <option value="Security">Security</option>
          </select>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button type="button" onclick="document.getElementById('editItemModal').close()" class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
        <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">Update</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Delete Item Modal -->
<dialog id="deleteItemModal" class="modal p-6 rounded-xl border border-slate-200 dark:border-slate-700 backdrop:bg-slate-900/50 w-full max-w-md">
  <div class="space-y-4">
    <div class="flex items-center gap-3">
      <div class="p-2 bg-red-100 dark:bg-red-900/30 rounded-full">
        <span class="material-symbols-outlined text-red-600 dark:text-red-400">warning</span>
      </div>
      <h3 class="text-lg font-bold text-slate-900 dark:text-white">Delete Task</h3>
    </div>
    <p class="text-slate-600 dark:text-slate-400">Are you sure you want to delete "<span id="deleteItemName"></span>"?</p>
    <form id="deleteItemForm" method="POST">
      <input type="hidden" name="_method" value="DELETE"/>
      <div class="flex gap-3 mt-6">
        <button type="button" onclick="document.getElementById('deleteItemModal').close()" class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
        <button type="submit" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Delete</button>
      </div>
    </form>
  </div>
</dialog>

<script>
function openEditItemModal(id, text, category) {
  document.getElementById('editItemText').value = text;
  document.getElementById('editItemCategory').value = category || 'General';
  document.getElementById('editItemForm').action = '/manager/items/' + id + '?_method=PUT';
  document.getElementById('editItemModal').showModal();
}

function confirmDeleteItem(id, text) {
  document.getElementById('deleteItemName').textContent = text;
  document.getElementById('deleteItemForm').action = '/manager/items/' + id + '?_method=DELETE';
  document.getElementById('deleteItemModal').showModal();
}
</script>
